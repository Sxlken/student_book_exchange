<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/favorites.js') }}"></script>
    <script src="{{ url_for('static', filename='js/messages.js') }}"></script>
    <title>{{ book['title'] }} - Student Book Exchange</title>
    <style>
        .book-detail-container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .book-detail {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .book-image {
            flex: 0 0 300px;
        }

        .book-image img {
            width: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .book-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 300px;
        }

        .book-title {
            font-size: 2em;
            margin-bottom: 10px;
            color: #333;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            width: 100%;
            line-height: 1.3;
        }

        .book-author {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .book-meta {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .meta-item i {
            color: #007bff;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .book-description {
            margin-top: 20px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .book-description h3 {
            margin-bottom: 10px;
        }
        
        .book-description p {
            white-space: pre-line;
        }
        
        .book-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
            border: none;
        }

        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }

        .book-actions {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            flex: 1;
            justify-content: center;
            max-width: 250px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0069d9;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* PDF buttons section */
        .pdf-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .book-actions {
                flex-direction: column;
            }
            
            .btn {
                max-width: 100%;
            }
        }

        .reviews-section {
            margin-top: 40px;
        }

        .review {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .reviewer {
            font-weight: bold;
            color: #495057;
        }

        .review-date {
            color: #6c757d;
            font-size: 0.9em;
        }

        .review-rating {
            color: #ffc107;
            font-size: 1.2em;
            margin: 5px 0;
        }

        .review-content {
            margin-top: 10px;
            color: #495057;
        }

        .no-reviews {
            font-style: italic;
            color: #6c757d;
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .stars {
            --percent: calc(var(--rating) / 5 * 100%);
            display: inline-block;
            font-size: 1.25em;
            font-family: Times;
            line-height: 1;
        }

        .stars::before {
            content: '★★★★★';
            letter-spacing: 3px;
            background: linear-gradient(90deg, #fc0 var(--percent), #ddd var(--percent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Review Form Styles */
        .review-form-container {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .review-form {
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }
        
        .rating-input {
            display: inline-flex;
            flex-direction: row-reverse;
            margin-top: 5px;
            position: relative;
        }
        
        .rating-input input {
            display: none;
        }
        
        .rating-input label {
            cursor: pointer;
            font-size: 2em;
            color: #ddd;
            margin: 0 2px;
            transition: color 0.2s ease;
        }
        
        .rating-input label:hover,
        .rating-input label:hover ~ label,
        .rating-input input:checked ~ label {
            color: #ffc107;
        }
        
        .rating-helper-text {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
        
        .reviews-list {
            margin-top: 20px;
        }
        
        .reviews-list h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            padding: 15px 25px;
            margin-bottom: 10px;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideIn 0.5s ease forwards;
        }

        .notification i {
            font-size: 1.2em;
        }

        .notification-success {
            background-color: #28a745;
        }

        .notification-error {
            background-color: #dc3545;
        }

        .notification-info {
            background-color: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification.fade-out {
            animation: fadeOut 0.5s ease forwards;
        }

        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-edit-review, .btn-delete-review {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            border: none;
            transition: background-color 0.2s;
        }

        .btn-edit-review {
            background-color: #6c757d;
            color: white;
        }

        .btn-edit-review:hover {
            background-color: #5a6268;
        }

        .btn-delete-review {
            background-color: #dc3545;
            color: white;
        }

        .btn-delete-review:hover {
            background-color: #c82333;
        }

        .book-owner {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
        }

        .owner-label {
            font-weight: 500;
            margin-right: 5px;
        }

        .owner-name {
            font-style: italic;
        }

        .message-btn {
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .message-btn:hover {
            background-color: #0069d9;
            color: white;
        }

        .message-btn i {
            margin-right: 5px;
        }

        .edit-review-form {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .edited-tag {
            font-size: 0.8em;
            color: #999;
            font-style: italic;
            margin-left: 5px;
        }

        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <a href="{{ url_for('home') }}">
                    <i class="fas fa-book-open"></i>
                    Student Book Exchange
                </a>
            </div>
            <div class="nav-links">
                {% if 'username' in session %}
                    <a href="{{ url_for('my_books') }}"><i class="fas fa-book"></i> My Books</a>
                    <a href="{{ url_for('add_book') }}"><i class="fas fa-plus-circle"></i> Share a Book</a>
                    <a href="{{ url_for('favorites') }}"><i class="fas fa-heart"></i> Favorites</a>
                    <a href="{{ url_for('messages') }}" class="message-badge-container"><i class="fas fa-envelope"></i> Messages</a>
                    <a href="{{ url_for('account') }}"><i class="fas fa-user"></i> Account</a>
                    <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
                {% else %}
                    <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Sign In</a>
                    <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> Register</a>
                {% endif %}
            </div>
        </nav>
    </header>

    <main>
        <div class="book-detail-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="notification-container">
                        {% for category, message in messages %}
                            <div class="notification notification-{{ category }}">
                                {% if category == 'success' %}
                                    <i class="fas fa-check-circle"></i>
                                {% elif category == 'error' %}
                                    <i class="fas fa-exclamation-circle"></i>
                                {% else %}
                                    <i class="fas fa-info-circle"></i>
                                {% endif %}
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="book-detail">
                <div class="book-image">
                    {% if book['image_path'] %}
                        <img src="{{ url_for('static', filename=book['image_path']) }}" alt="{{ book['title'] }}">
                    {% else %}
                        <img src="{{ url_for('static', filename='images/default_book.png') }}" alt="Default book cover">
                    {% endif %}
                </div>
                <div class="book-info">
                    <h1 class="book-title">{{ book['title'] }}</h1>
                    
                    <div class="book-meta">
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>Author: {{ book['author'] }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-tag"></i>
                            <span>Category: {{ book['category_name'] }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Condition: {{ book['condition']|title }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Added: 
                            {% if book['added_date'] is string %}
                                {{ book['added_date'] }}
                            {% else %}
                                {{ book['added_date'].strftime('%d/%m/%y %H:%M:%S') }}
                            {% endif %}
                            </span>
                        </div>
                        {% if book['isbn'] %}
                        <div class="meta-item">
                            <i class="fas fa-barcode"></i>
                            <span>ISBN: {{ book['isbn'] }}</span>
                        </div>
                        {% endif %}
                        <div class="meta-item">
                            <i class="fas fa-user-edit"></i>
                            <span>Publisher: {{ book['owner_display_name'] }}</span>
                        </div>
                        {% if book['publication_year'] %}
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>Publication Year: {{ book['publication_year'] }}</span>
                        </div>
                        {% endif %}
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>Loan Duration: 
                                {% if book['loan_duration']|int == 7 %}
                                    1 Week
                                {% elif book['loan_duration']|int == 14 %}
                                    2 Weeks
                                {% elif book['loan_duration']|int == 30 %}
                                    1 Month
                                {% elif book['loan_duration']|int == 90 %}
                                    3 Months
                                {% else %}
                                    {{ book['loan_duration']|int }} days
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <div class="book-rating">
                        <div class="stars" style="--rating: {{ book['avg_rating'] }}"></div>
                        <span>({{ book['review_count'] }} {% if book['review_count'] == 1 %}review{% else %}reviews{% endif %})</span>
                    </div>
                    
                    <div class="book-description">
                        <h3>Description</h3>
                        <p>{{ book['description'] }}</p>
                    </div>
                    
                    <div class="book-actions">
                        {% if session.get('user_id') != book['owner_id'] %}
                            <button data-book-id="{{ book['id'] }}" class="btn btn-success toggle-favorite" style="width: 100%;">
                                {% if is_favorite %}
                                    <i class="fas fa-heart" style="color: #ea4335;"></i> Remove from Favorites
                                {% else %}
                                    <i class="far fa-heart"></i> Add to Favorites
                                {% endif %}
                            </button>
                        {% else %}
                            <!-- Modified Edit Book link with additional class and direct navigation -->
                            <a href="{{ url_for('edit_book', book_id=book['id']) }}" class="btn btn-primary edit-book-btn" style="flex: 1; max-width: 250px; width: 100%;">
                                <i class="fas fa-edit"></i> Edit Book
                            </a>
                            
                            <form action="{{ url_for('delete_book', book_id=book['id']) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this book?');" style="flex: 1; max-width: 250px;">
                                <button type="submit" class="btn btn-danger" style="width: 100%;">
                                    <i class="fas fa-trash"></i> Delete Book
                                </button>
                            </form>
                        {% endif %}
                        
                        {% if book.pdf_path %}
                            <div class="pdf-section" style="width: 100%; margin-top: 20px;">
                                <h3 style="margin-bottom: 10px;"><i class="fas fa-file-pdf"></i> PDF Options</h3>
                                <div class="pdf-buttons">
                                    <a href="{{ url_for('download_pdf', book_id=book['id']) }}" class="btn btn-info" style="flex: 1; max-width: 250px;">
                                        <i class="fas fa-download"></i> Download PDF
                                    </a>
                                    
                                    <a href="{{ url_for('download_pdf', book_id=book['id'], view='inline') }}" class="btn btn-secondary" target="_blank" style="flex: 1; max-width: 250px;">
                                        <i class="fas fa-eye"></i> View PDF Online
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    {% if book['owner_display_name'] %}
                        <div class="book-owner">
                            <span class="owner-label">Owner:</span>
                            <span class="owner-name">{{ book['owner_display_name'] }}</span>
                            {% if 'username' in session and session.get('user_id') != book['owner_id'] %}
                                <a href="{{ url_for('start_chat', receiver_id=book['owner_id']) }}?book_id={{ book['id'] }}" class="message-btn">
                                    <i class="fas fa-comments"></i> Send a message
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="reviews-section">
                <h2>Reviews</h2>
                
                {% if 'user_id' in session and session.get('user_id') != book['owner_id'] %}
                    <div class="review-form-container">
                        <h3>Add Your Review</h3>
                        <form action="{{ url_for('add_review', book_id=book['id']) }}" method="post" class="review-form">
                            <div class="form-group">
                                <label for="rating">Rating:</label>
                                <div class="rating-input">
                                    <input type="radio" id="star5" name="rating" value="5" required>
                                    <label for="star5" title="5 stars">★</label>
                                    <input type="radio" id="star4" name="rating" value="4">
                                    <label for="star4" title="4 stars">★</label>
                                    <input type="radio" id="star3" name="rating" value="3">
                                    <label for="star3" title="3 stars">★</label>
                                    <input type="radio" id="star2" name="rating" value="2">
                                    <label for="star2" title="2 stars">★</label>
                                    <input type="radio" id="star1" name="rating" value="1">
                                    <label for="star1" title="1 star">★</label>
                                </div>
                                <div class="rating-helper-text">Click on a star to rate (5 = best, 1 = worst)</div>
                            </div>
                            <div class="form-group">
                                <label for="comment">Comment:</label>
                                <textarea name="comment" id="comment" rows="4" required placeholder="Share your thoughts about this book..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                {% endif %}
                
                <div class="reviews-list">
                    <h3>User Reviews</h3>
                {% if reviews %}
                    {% for review in reviews %}
                        <div class="review">
                            <div class="review-header">
                                <span class="reviewer">{{ review.reviewer_display_name }}</span>
                                <span class="review-date">
                                    {% if review.created_at is string %}
                                        {{ review.created_at }}
                                    {% else %}
                                        {{ review.created_at.strftime('%d/%m/%y %H:%M:%S') }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="review-rating">
                                {% for i in range(review.rating) %}
                                    <span class="star">★</span>
                                {% endfor %}
                                {% for i in range(5 - review.rating) %}
                                    <span class="star empty">☆</span>
                                {% endfor %}
                            </div>
                            <div class="review-content">
                                <p>{{ review.comment }}</p>
                                {% if review.edited_at %}
                                    <span class="edited-tag">(edited)</span>
                                {% endif %}
                            </div>
                            
                            {% if session.get('user_id') == review.reviewer_id %}
                                <div class="review-actions">
                                    <button class="btn-edit-review" data-review-id="{{ review.id }}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn-delete-review" data-review-id="{{ review.id }}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                                
                                <div class="edit-review-form" id="edit-review-form-{{ review.id }}" style="display: none;">
                                    <form class="review-edit-form" data-review-id="{{ review.id }}">
                                        <div class="form-group">
                                            <label for="edit-rating-{{ review.id }}">Rating:</label>
                                            <div class="rating-input edit-rating">
                                                <input type="radio" id="edit-star5-{{ review.id }}" name="rating" value="5" {% if review.rating == 5 %}checked{% endif %}>
                                                <label for="edit-star5-{{ review.id }}" title="5 stars">★</label>
                                                <input type="radio" id="edit-star4-{{ review.id }}" name="rating" value="4" {% if review.rating == 4 %}checked{% endif %}>
                                                <label for="edit-star4-{{ review.id }}" title="4 stars">★</label>
                                                <input type="radio" id="edit-star3-{{ review.id }}" name="rating" value="3" {% if review.rating == 3 %}checked{% endif %}>
                                                <label for="edit-star3-{{ review.id }}" title="3 stars">★</label>
                                                <input type="radio" id="edit-star2-{{ review.id }}" name="rating" value="2" {% if review.rating == 2 %}checked{% endif %}>
                                                <label for="edit-star2-{{ review.id }}" title="2 stars">★</label>
                                                <input type="radio" id="edit-star1-{{ review.id }}" name="rating" value="1" {% if review.rating == 1 %}checked{% endif %}>
                                                <label for="edit-star1-{{ review.id }}" title="1 star">★</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-comment-{{ review.id }}">Comment:</label>
                                            <textarea name="comment" id="edit-comment-{{ review.id }}" rows="4" required>{{ review.comment }}</textarea>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary btn-disabled" disabled>Save Changes</button>
                                            <button type="button" class="btn btn-secondary cancel-edit">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-reviews">
                        <p>No reviews yet. Be the first to review this book!</p>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>About Us</h3>
                <p>Student Book Exchange is a platform for students to share and exchange books within their university community.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="{{ url_for('about') }}">About</a></li>
                    <li><a href="{{ url_for('how_it_works') }}">How It Works</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact</h3>
                <p><i class="fab fa-telegram-plane"></i> @prime_e1ght</p>
                <p><a href="https://github.com/Sxlken" target="_blank"><i class="fab fa-github"></i> Sxlken</a></p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Student Book Exchange. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Store current user ID for JavaScript use
        const currentUserId = "{{ session.get('user_id', 0) }}";
        
        // Auto-hide notifications after 3 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const notifications = document.querySelectorAll('.notification');
            notifications.forEach(notification => {
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }, 3000);
            });

            // Attach edit review button handlers
            attachEditReviewHandlers();
            
            // Attach delete review button handlers
            attachDeleteReviewHandlers();
        });

        // Favorites toggle function
        function toggleFavorite(bookId) {
            fetch(`/toggle_favorite/${bookId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const favoriteBtn = document.querySelector(`button[data-book-id="${bookId}"]`);
                if (data.status === 'added') {
                    favoriteBtn.innerHTML = '<i class="fas fa-heart" style="color: red;"></i> Remove from Favorites';
                    showNotification('Book added to favorites!', 'success');
                } else if (data.status === 'removed') {
                    favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
                    showNotification('Book removed from favorites!', 'info');
                } else if (data.status === 'error') {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred', 'error');
            });
        }

        // Submit review form with AJAX
        document.addEventListener('DOMContentLoaded', function() {
            // Enhance star rating interaction
            const ratingLabels = document.querySelectorAll('.rating-input label');
            const ratingInputs = document.querySelectorAll('.rating-input input');
            const ratingHelperText = document.querySelector('.rating-helper-text');
            
            if (ratingLabels.length > 0 && ratingHelperText) {
                ratingLabels.forEach(label => {
                    label.addEventListener('click', function() {
                        const stars = this.getAttribute('title').split(' ')[0];
                        ratingHelperText.textContent = `You selected ${stars} star${stars > 1 ? 's' : ''} (${stars === '5' ? 'excellent' : stars === '4' ? 'good' : stars === '3' ? 'average' : stars === '2' ? 'poor' : 'terrible'})`;
                        ratingHelperText.style.color = '#007bff';
                        ratingHelperText.style.fontWeight = 'bold';
                    });
                });
            }
            
            const reviewForm = document.querySelector('.review-form');
            if (reviewForm) {
                reviewForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Validate form
                    const rating = document.querySelector('input[name="rating"]:checked');
                    const comment = document.getElementById('comment');
                    
                    if (!rating) {
                        showNotification('Please select a rating', 'error');
                        return;
                    }
                    
                    if (!comment.value.trim()) {
                        showNotification('Please enter a comment', 'error');
                        comment.focus();
                        return;
                    }
                    
                    const formData = new FormData(this);
                    const bookId = window.location.pathname.split('/').pop();
                    
                    console.log('Sending review for book ID:', bookId);
                    console.log('Form data:', {
                        rating: formData.get('rating'),
                        comment: formData.get('comment').substring(0, 20) + '...' // For privacy, only log part of the comment
                    });
                    
                    fetch(`/add_review/${bookId}`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        console.log('Response headers:', {
                            'content-type': response.headers.get('content-type')
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Server responded with status: ${response.status}`);
                        }
                        
                        // Check if the response is JSON
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            // If not JSON, it's a redirect or HTML response
                            // Reload the page to show the flash message
                            window.location.reload();
                            return null;
                        }
                    })
                    .then(data => {
                        if (!data) return; // If we got a non-JSON response and reloaded
                        
                        if (data.status === 'success') {
                            showNotification(data.message, 'success');
                            
                            // Clear the form
                            document.getElementById('comment').value = '';
                            document.querySelectorAll('.rating-input input').forEach(input => {
                                input.checked = false;
                            });
                            
                            // Update reviews list
                            updateReviewsList(data.reviews);
                        } else {
                            showNotification(data.message || 'Error submitting review', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification(`Error submitting review: ${error.message}`, 'error');
                    });
                });
            }
        });
        
        // Function to update the reviews list
        function updateReviewsList(reviews) {
            const reviewsList = document.querySelector('.reviews-list');
            let reviewsHTML = '<h3>User Reviews</h3>';
            
            if (reviews && reviews.length > 0) {
                reviews.forEach(review => {
                    const reviewStars = [];
                    for (let i = 0; i < 5; i++) {
                        if (i < review.rating) {
                            reviewStars.push('<span class="star">★</span>');
                        } else {
                            reviewStars.push('<span class="star empty">☆</span>');
                        }
                    }
                    const starsHTML = reviewStars.join('');
                    
                    // Format the date consistently in DD/MM/YY HH:MM:SS format
                    let date;
                    try {
                        // Try to create a Date object from the timestamp
                        if (typeof review.created_at === 'string') {
                            // If already in the right format, use it directly
                            if (review.created_at.match(/\d{2}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}/)) {
                                date = review.created_at;
                            } 
                            // If it's an ISO timestamp, format it to our desired format
                            else if (review.created_at.includes('T')) {
                                const dateObj = new Date(review.created_at);
                                date = dateObj.toLocaleDateString('en-GB', { 
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: '2-digit'
                                }) + ' ' + dateObj.toLocaleTimeString('en-GB', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                });
                            } else {
                                // If it's already in some other format, use it as is
                                date = review.created_at;
                            }
                        } else {
                            date = 'Unknown date';
                        }
                    } catch (e) {
                        // If there's an error parsing the date, use the raw value
                        date = review.created_at || 'Unknown date';
                    }
                    
                    // Check if the review is from the current user
                    const isCurrentUserReview = currentUserId && review.reviewer_id == currentUserId;
                    
                    // Check if review has been edited
                    const editedTag = review.edited_at ? '<span class="edited-tag">(edited)</span>' : '';
                    
                    reviewsHTML += `
                        <div class="review">
                            <div class="review-header">
                                <span class="reviewer">${review.reviewer_display_name}</span>
                                <span class="review-date">${date}</span>
                            </div>
                            <div class="review-rating">
                                ${starsHTML}
                            </div>
                            <div class="review-content">
                                <p>${review.comment}</p>
                                ${editedTag}
                            </div>
                            
                            ${isCurrentUserReview ? `
                            <div class="review-actions">
                                <button class="btn-edit-review" data-review-id="${review.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-delete-review" data-review-id="${review.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            
                            <div class="edit-review-form" id="edit-review-form-${review.id}" style="display: none;">
                                <form class="review-edit-form" data-review-id="${review.id}">
                                    <div class="form-group">
                                        <label for="edit-rating-${review.id}">Rating:</label>
                                        <div class="rating-input edit-rating">
                                            <input type="radio" id="edit-star5-${review.id}" name="rating" value="5" ${review.rating == 5 ? 'checked' : ''}>
                                            <label for="edit-star5-${review.id}" title="5 stars">★</label>
                                            <input type="radio" id="edit-star4-${review.id}" name="rating" value="4" ${review.rating == 4 ? 'checked' : ''}>
                                            <label for="edit-star4-${review.id}" title="4 stars">★</label>
                                            <input type="radio" id="edit-star3-${review.id}" name="rating" value="3" ${review.rating == 3 ? 'checked' : ''}>
                                            <label for="edit-star3-${review.id}" title="3 stars">★</label>
                                            <input type="radio" id="edit-star2-${review.id}" name="rating" value="2" ${review.rating == 2 ? 'checked' : ''}>
                                            <label for="edit-star2-${review.id}" title="2 stars">★</label>
                                            <input type="radio" id="edit-star1-${review.id}" name="rating" value="1" ${review.rating == 1 ? 'checked' : ''}>
                                            <label for="edit-star1-${review.id}" title="1 star">★</label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-comment-${review.id}">Comment:</label>
                                        <textarea name="comment" id="edit-comment-${review.id}" rows="4" required>${review.comment}</textarea>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary btn-disabled" disabled>Save Changes</button>
                                        <button type="button" class="btn btn-secondary cancel-edit">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                reviewsHTML += `
                    <div class="no-reviews">
                        <p>No reviews yet. Be the first to review this book!</p>
                    </div>
                `;
            }
            
            reviewsList.innerHTML = reviewsHTML;
            
            // Re-attach event listeners
            attachEditReviewHandlers();
            attachDeleteReviewHandlers();
            
            // Setup change detection for any newly created forms
            setupEditFormChangeDetection();
        }
        
        // Add event listeners to detect changes in the edit form
        function setupEditFormChangeDetection() {
            document.querySelectorAll('.review-edit-form').forEach(form => {
                const reviewId = form.dataset.reviewId;
                const saveButton = form.querySelector('button[type="submit"]');
                const originalRating = form.querySelector('input[name="rating"]:checked')?.value || '';
                const originalComment = form.querySelector('textarea[name="comment"]').value;
                
                // Initially disable the save button
                saveButton.disabled = true;
                saveButton.classList.add('btn-disabled');
                
                // Function to check if form has been changed
                function checkFormChanged() {
                    const currentRating = form.querySelector('input[name="rating"]:checked')?.value || '';
                    const currentComment = form.querySelector('textarea[name="comment"]').value;
                    
                    const hasChanged = (currentRating !== originalRating || currentComment !== originalComment);
                    
                    // Enable/disable button based on whether changes were made
                    saveButton.disabled = !hasChanged;
                    if (hasChanged) {
                        saveButton.classList.remove('btn-disabled');
                    } else {
                        saveButton.classList.add('btn-disabled');
                    }
                }
                
                // Add input event listeners to all form fields
                form.querySelectorAll('input[name="rating"]').forEach(radio => {
                    radio.addEventListener('change', checkFormChanged);
                });
                
                form.querySelector('textarea[name="comment"]').addEventListener('input', checkFormChanged);
            });
        }

        // Call this function after the review form is displayed
        function attachEditReviewHandlers() {
            document.querySelectorAll('.btn-edit-review').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.dataset.reviewId;
                    const reviewForm = document.getElementById(`edit-review-form-${reviewId}`);
                    
                    // Hide all other edit forms
                    document.querySelectorAll('.edit-review-form').forEach(form => {
                        if (form.id !== `edit-review-form-${reviewId}`) {
                            form.style.display = 'none';
                        }
                    });
                    
                    // Toggle current form
                    if (reviewForm.style.display === 'none' || reviewForm.style.display === '') {
                        reviewForm.style.display = 'block';
                        setupEditFormChangeDetection(); // Set up change detection when form is shown
                    } else {
                        reviewForm.style.display = 'none';
                    }
                });
            });
            
            // Cancel button handlers
            document.querySelectorAll('.cancel-edit').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.closest('.edit-review-form').style.display = 'none';
                });
            });
            
            // Form submission handlers
            document.querySelectorAll('.review-edit-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const reviewId = this.dataset.reviewId;
                    const rating = this.querySelector('input[name="rating"]:checked')?.value;
                    const comment = this.querySelector('textarea[name="comment"]').value;
                    
                    if (!rating || !comment.trim()) {
                        alert('Please provide both a rating and a comment.');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('rating', rating);
                    formData.append('comment', comment);
                    
                    fetch(`/edit_review/${reviewId}`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Show success notification
                            showNotification(data.message || 'Your review has been updated', 'success');
                            
                            // Update the reviews list with the updated reviews
                            updateReviewsList(data.reviews);
                        } else {
                            showNotification(data.message || 'An error occurred while editing your review', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error editing review:', error);
                        showNotification('An error occurred while editing your review', 'error');
                    });
                });
            });
        }
        
        function attachDeleteReviewHandlers() {
            // Attach event listeners for delete buttons
            document.querySelectorAll('.btn-delete-review').forEach(button => {
                button.addEventListener('click', function() {
                    if (!confirm('Are you sure you want to delete this review?')) {
                        return;
                    }
                    
                    const reviewId = this.dataset.reviewId;
                    
                    fetch(`/delete_review/${reviewId}`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server responded with status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            showNotification(data.message, 'success');
                            updateReviewsList(data.reviews);
                        } else {
                            showNotification(data.message || 'Error deleting review', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification(`Error deleting review: ${error.message}`, 'error');
                    });
                });
            });
        }

        // Function to show notifications
        function showNotification(message, type) {
            // Create container if it doesn't exist
            let container = document.querySelector('.notification-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'notification-container';
                document.body.appendChild(container);
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            // Add icon based on type
            let icon = '';
            if (type === 'success') {
                icon = '<i class="fas fa-check-circle"></i> ';
            } else if (type === 'error') {
                icon = '<i class="fas fa-exclamation-circle"></i> ';
            } else {
                icon = '<i class="fas fa-info-circle"></i> ';
            }
            
            notification.innerHTML = icon + message;
            
            // Append notification to container
            container.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Force direct navigation for the edit button
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const editUrl = this.action;
                    console.log('Navigating to:', editUrl);
                    window.location.href = editUrl;
                });
            }
            
            // Also handle direct click on the button
            const editButton = document.getElementById('editButton');
            if (editButton) {
                editButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const editUrl = editForm.action;
                    console.log('Button clicked, navigating to:', editUrl);
                    window.location.href = editUrl;
                    return false;
                });
            }
        });
    </script>
</body>
</html>